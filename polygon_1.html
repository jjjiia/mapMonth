<!DOCTYPE html>
<html>
<head>

	  <meta charset="UTF-8">
    <title>SVI v0.1</title>

    <meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
    <!-- <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"> -->
  <script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.js"></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.css' rel='stylesheet' />

  <link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>


<link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@700&family=Raleway:wght@600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bai+Jamjuree:wght@700&family=Coda+Caption:wght@800&family=Hammersmith+One&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>

<script src="https://code.jquery.com/jquery-1.12.4.min.js"
        integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ"
        crossorigin="anonymous">
</script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/queue.v1.min.js"></script>
    <style>
		body{
			font-family:helvetica;
		}
        #title{
        	font-size:18px;
        }
		#chart{
			position:fixed;
			top:0px;
			left:0px;
		}
</style>

</head>
<div id="title">Congressional Districts*</div>
<div id="chart"></div>

<body>

<script>
	var congress = d3.json("congressional_perimeter.geojson")
	var centroids = d3.json("congressional_centroids.geojson")
	Promise.all([congress,centroids])
	.then(function(data){
		
	        
		drawPolygons(data[0],data[1])
	})
	function drawPolygons(data,centroids){
		var w = 50
		var h = 50
		
		var formatted = byId(data)
		var formattedCentroids = byId(centroids)
		
		var sorted = data["features"].sort(function(a,b){return a.ratio-b.ratio})
		
		var ratioExtent = d3.extent(data.features,function(d){
			//if(d.properties.GEOID!="0200"){
			return d.ratio
				//}
		})
		var areaExtent = d3.extent(data.features,function(d){
															if(d.properties.GEOID!="0200"){
																return Math.sqrt(d.properties.ALAND)
															}
														})
		var periExtent = d3.extent(data.features,function(d){
														if(d.properties.GEOID!="0200"){
																return Math.sqrt(d.properties.perimeter)
														}
													})
		
		var ratioScale = d3.scaleLinear().domain(ratioExtent).range([50,w])
													
		var xScale = d3.scaleLinear().domain(areaExtent).range([50,w])
		var yScale = d3.scaleLinear().domain(periExtent).range([50,h])
		
		var zScale =	d3.scaleLinear().domain(areaExtent).range([1000,100])									
		
		console.log(ratioExtent)
		for(var c in sorted){
			var svg = d3.select("#chart").append("svg").attr("width",w).attr("height",h)
			
			//console.log(formatted[c])
			var gid = sorted[c].properties.GEOID
			var center = formattedCentroids[gid].geometry.coordinates
		//console.log(zScale(formatted[c].properties.ALAND))
			
	        var projection = d3.geoAlbers()
                    .fitExtent([[5,5],[w-5,h-5]],formatted[c])
			
			//.scale(zScale(Math.sqrt(formatted[c].properties.ALAND)))
			var centerXY = projection(center)
	        var path = d3.geoPath().projection(projection)
			
			var ratioOffset = ratioScale(sorted[c].ratio)
			
			var offsetX = xScale(Math.sqrt(sorted[c].properties.ALAND))
			var offsetY = yScale(Math.sqrt(sorted[c].properties.perimeter))
			
			//console.log(offsetX)
		
			var formattedDistrict = {}
			formattedDistrict["type"]="FeatureCollection"
			formattedDistrict["crs"]=data["crs"]
			formattedDistrict["features"]=[formatted[gid]]
		
	        svg//.selectAll("#_"+gid)
				.append("path")
	            .attr("d", path(formattedDistrict))
	            .attr("fill", "none")
	            .attr("stroke","black")
				.attr("stroke-width",.5)
				.attr("opacity",.5)
				.attr("id","_"+gid)
				//.attr("transform","translate("+(-(centerXY[0]))+","+(-(centerXY[1]))+")")
				.on("mouseover",function(){
					var thisId = d3.select(this).attr("id")
					var data = formatted[thisId]
					console.log(data)
				})
			//break
		}
		
	}
	
    function byId(data){
		var formatted = {}
		for(var i in data.features){
			
			var gid = data.features[i].properties.GEOID
			var district = data["features"][i]
			var area = district.properties.ALAND
			var peri = district.properties.perimeter
			var ratio = peri/area
			district["ratio"]=ratio
			formatted[gid]=district
		}
		return formatted
    }
	
</script>


</body>
</html>
